<html>
<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>Robinhood 1099-B Transactions Export Tool</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding-top: 70px;
      /* Required padding for .navbar-fixed-top. Remove if using .navbar-static-top. Change if height of navigation changes. */
    }
  </style>
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
      </head>
      <body>

        <!-- Navigation -->
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
          <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="#">Robinhood 1099-B Transactions Export Tool</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <ul class="nav navbar-nav">
                <li>
                  <a target="_blank" href="https://github.com/JiahaoShan/Robinhood-1099-B-Transactions-Export-Tool">Github</a>
                </li>
                <li>
                  <a target="_blank" href="https://www.linkedin.com/in/jiahaoshan">Author</a>
                </li>
              </ul>
            </div>
            <!-- /.navbar-collapse -->
          </div>
          <!-- /.container -->
        </nav>

        <!-- Page Content -->
        <div class="container" ng-app="app" ng-controller="myCtrl">

          <div class="row">
            <div class="col-lg-12 text-center">
              <h1>Robinhood 1099-B Transactions Export Tool</h1>
              <h3 class="lead">No information will be uploaded (EVEN NO SERVER EXISTED) All work is done by your computer!</h3>
              <p class="lead">Please select the Consolidated Form 1099 PDF generated by Robinhood</p>
              <div class="alert alert-info" ng-if="message" ng-class="{'alert-danger' : error}">{{message}}</div>

              <div class="form-group">
                <input type="file" id="inputElement">
                <button ng-if="transactions" ng-class="{'btn-warning': error }" type="button" class="btn btn-primary btn-block" ng-click="export(transactions)">Export <span ng-if="error" style="color: red;">WITH ERROR</span></button>
              </div>

              <div id="transactions" ng-if="transactions">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th ng-repeat="header in headers"><input ng-model="header" class="form-control"></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr ng-repeat="transaction in transactions track by $index" ng-class="{'danger' : flagTransaction(transaction, $index, transactions)}">
                      <td ng-click="editTransaction(transaction)" style="cursor: pointer;">
                        <input class="form-control" ng-if="$index == 0 || transactions[$index - 1]['name'] != transaction.name || transaction.edit" ng-model="transaction.name" ng-change="nameChange(transactions, $index, '{{transaction.name}}')">
                        <span ng-if="!transaction.edit && $index > 0 && transactions[$index - 1]['name'] == transaction.name">{{transaction.name}}</span>
                      </td>
                      <td><input class="form-control" ng-model="transaction.purchase"></td>
                      <td><input class="form-control" ng-model="transaction.sold"></td>
                      <td><input class="form-control" ng-model="transaction.proceeds"></td>
                      <td><input class="form-control" ng-model="transaction.cost"></td>
                    </tr>
                    <tr class="info">
                      <td>Total: {{transactions.length}} transaction{{transactions.length > 0 ? 's' : ''}}</td>
                      <td></td>
                      <td></td>
                      <td>{{getTotalProceeds(transactions)|currency}}</td>
                      <td>{{getTotalCost(transactions)|currency}}</td>
                    </tr>
                  </tbody>
                </div>

              </div>
            </div>
            <!-- /.row -->

          </div>
          <!-- /.container -->
        </body>

        <script src="js/jquery.js"></script>
        <script type="text/javascript" src="https://cdn.rawgit.com/mozilla/pdf.js/gh-pages/build/pdf.js"></script>
        <script src="ocrad.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js"></script> 
        <script src="js/bootstrap.min.js"></script>

        <script type="text/javascript">
          var app = angular.module('app', []);
          app.controller('myCtrl', function($scope) {
            $scope.error = false;
            $scope.page = 0;

            $scope.export = function(transactions) {
              var lineArray = [];
              lineArray.push($scope.headers);
              transactions.forEach(function (transaction, index) {
                var csa = [];
                csa.push(transaction.name ? transaction.name : "");
                csa.push(transaction.purchase ? transaction.purchase : "");
                csa.push(transaction.sold ? transaction.sold : "");
                csa.push(transaction.proceeds ? transaction.proceeds : "");
                csa.push(transaction.cost ? transaction.cost : "");
                // var line = csa.join(",");
                lineArray.push(csa);
              });
              exportToCsv("robinhood_transactions_" + year, lineArray);
              // var csvContent = lineArray.join("\n");
              // var encodedUri = encodeURI(csvContent);
              // var a = document.createElement('a');
              // a.href = encodedUri;
              // a.target = "_blank";
              // document.getElementById("download").appendChild(a);
            }
            $scope.nameChange = function(transactions, index, oldName) {
              for (var i = index + 1; i < transactions.length; i++) {
                if (transactions[i].edit) break;
                if (transactions[i].name == oldName) {
                  transactions[i].name = transactions[index]['name'];
                }
                else {
                  break;
                }
              }
            }
            $scope.editTransaction = function(transaction) {
              transaction.edit = true;
            }
            $scope.headers = ['name','acquired','sold','proceeds','cost'];
            $scope.flagTransaction = function(transaction, index, transactions) {
              if (index == 0) {
                $scope.error = false;
              }
              if(!transaction.name || !transaction.purchase || !transaction.sold || !transaction.proceeds || !transaction.cost) {
                $scope.error = true;
                return true;
              }
              if (!isValidDateString(transaction.purchase) || !isValidDateString(transaction.sold)) {
                $scope.error = true;
                return true;
              }
              var purchaseDate = new Date(transaction.purchase);
              var soldDate = new Date(transaction.sold);
              if (purchaseDate.getTime() > soldDate.getTime()) {
                $scope.error = true;
                return true;
              }
              if (isNaN(transaction.proceeds) || isNaN(transaction.cost)) {
                $scope.error = true;
                return true;
              }
              return false;
            }
            $scope.getTotalProceeds = function(transactions) {
              var totalProceeds = 0;
              transactions.forEach(function (transaction, index) {
                if (!isNaN(transaction.proceeds)) {
                  totalProceeds += parseFloat(transaction.proceeds);
                }
              });
              return totalProceeds;
            }
            $scope.getTotalCost = function(transactions) {
              var totalCost = 0;
              transactions.forEach(function (transaction, index) {
                if (!isNaN(transaction.cost)) {
                  totalCost += parseFloat(transaction.cost);
                }
              });
              return totalCost;
            }

            var inputElement = document.getElementById("inputElement");
            var texts = {};
            var candidateLine = [];
            var candidateTransactions = [];
            var transactions = [];
            var names = [];
            var today = new Date();
            var year = getParameterByName('year') ? getParameterByName('year') : today.getFullYear() - 1;
            inputElement.onchange = function(event) {
              var file = event.target.files[0];
              if (file.type != "application/pdf") {
                $scope.error = true;
                $scope.message = "ERROR: Only 1099 PDF is supported.";
                $scope.$apply();
                return;
              }
              var fileReader = new FileReader();  
              fileReader.onload = function() {
                var typedarray = new Uint8Array(this.result);
                $scope.working = true;
                PDFJS.getDocument(typedarray).then(function(pdf) {
                  $scope.error = false;
                  $scope.message = "Your document has " + pdf.numPages + " pages. It's loading...";
                  $scope.$apply();
                  readPage(pdf,1);
                });
              };
              fileReader.readAsArrayBuffer(file);
            }

            function readPage(pdf, number) {
              if (number > pdf.numPages) {
                console.log('finished!!');
                $scope.working = false;
                for (var i = 1; i <= pdf.numPages; i++) {
                  var allTextLines = texts[i].split(/\r\n|\n/);
                  var candidateStarted = 0;
                  var lastProceeds = 0;
                  for (var j = 0; j < allTextLines.length; j++) {
                    if (allTextLines[j] == "") continue;
                    var lineWithNoSpace = allTextLines[j].replace(/\s/g, '');
                    if (lineWithNoSpace.indexOf('Box1a') > 0 ||
                      lineWithNoSpace.indexOf('Box1b') > 0 ||
                      lineWithNoSpace.indexOf('Box1c') > 0 ||
                      lineWithNoSpace.indexOf('Box1d') > 0 ||
                      lineWithNoSpace.indexOf('Box1e') > 0) {
                      candidateStarted = 1;
                    continue;
                  }
                  if (candidateStarted == 2 
                    || (candidateStarted == 1 && isTransactionLine(lineWithNoSpace))) {
                    candidateStarted = 2;
                  candidateLine.push(allTextLines[j]);
                  if (lineWithNoSpace.indexOf('Box6') > 0 ||
                    lineWithNoSpace.indexOf('Proceeds') > 0) {
                    lastProceeds = 0;
                }
                else {
                  lastProceeds += 1;
                }
              }
            }
            candidateLine.splice(candidateLine.length - lastProceeds,lastProceeds);
          }
          analyzeLines(candidateLine);
          return;
        }
        pdf.getPage(number).then(function getPageHelloWorld(page) {
          $scope.message = "Recognizing the " + number + " of " + pdf.numPages + " page" ;
          for (var i = 0; i < number % 4; i++) {
            $scope.message += '.';
          }
          $scope.$apply();
          var scale = 5;
          var viewport = page.getViewport(scale);
              //
              // Prepare canvas using PDF page dimensions
              //
              var DPI = 72; // increase to improve quality
              var PRINT_OUTPUT_SCALE = DPI/72; 
              var canvas = document.createElement('canvas');
              var context = canvas.getContext('2d');
              canvas.width = Math.floor(viewport.width * PRINT_OUTPUT_SCALE);
              canvas.height = Math.floor(viewport.height * PRINT_OUTPUT_SCALE);
              //
              // Render PDF page into canvas context
              //
              var task = page.render({canvasContext: context, viewport: viewport})
              task.promise.then(function(){
                var string = OCRAD(canvas);
                texts[number] = string;
                readPage(pdf, number + 1);
                console.log(string);
                // var image_data = context.getImageData(0, 0, context.width, context.height);
                // runOCR(image_data, true);
                //console.log(canvas.toDataURL('image/jpeg'));
              });
            });
      }

      function analyzeLines(candidateLine) {
        names = extractNames(candidateLine);
        for (var i = 0; i < candidateLine.length; i++) {
          if (isTransactionLine(candidateLine[i])) {
            transactions.push(extractTransaction(candidateLine[i], false, getTransactionNameByLineNumber(i)));
          }
        }
        if (transactions.length == 0) {
          $scope.error = true;
          $scope.message = "Sorry, no transaction is recognized.";
        }
        else {
          $scope.message = null;
          $scope.transactions = transactions;
          alert("Extractions are based on OCR and NO accuracy is guaranteed! Please check the transactions one by one.");
        }
        $scope.$apply()
      }

      function getTransactionNameByLineNumber(lineNumber) {
        for (var i = 0 ; i < names.length; i++) {
          if (lineNumber >= names[i]['start'] && lineNumber <= names[i]['end']) return names[i]['name'];
        }
        return "";
      }

      function extractNames(candidateLine) {
        var nameExtracting = false;
        var names = [];
        var nameBlocks = [];
        var startIndex = 0;
        for (var i = 0; i < candidateLine.length; i++) {
          if (isTransactionLine(candidateLine[i])) {
            var result = extractTransaction(candidateLine[i], true);
            if (result.stop || (nameExtracting && !result.nameAddOn)) {
              var nameRange = {'start': startIndex, 'name': nameBlocks.join(' ')};
              names.push(nameRange);
              nameBlocks = [];
              nameExtracting = false;
            }
            else if (!nameExtracting && result.nameAddOn) {
                // new company name found
                if (names.length) {
                  var lastNameRange = names[names.length-1];
                  lastNameRange.end = i - 1;
                }
                startIndex = i;
                nameExtracting = true;
                nameBlocks.push(result.nameAddOn);
              }
              else if (nameExtracting && result.nameAddOn) {
                nameBlocks.push(result.nameAddOn);
              }
            }
            else if (nameExtracting){
              var result = extractNameFromNonTransactionLine(candidateLine[i]);
              if (result.stop) {
                var nameRange = {'start': startIndex, 'name': nameBlocks.join(' ')};
                names.push(nameRange);
                nameBlocks = [];
                nameExtracting = false;
              }
              else if (result.nameAddOn) {
                nameBlocks.push(result.nameAddOn);
              }
            }
          }
    // add end range to the last name
    if (names.length) {
      var lastNameRange = names[names.length-1];
      lastNameRange.end = candidateLine.length;
    }
    return names;
  }

  function extractNameFromNonTransactionLine(line) {
    var result = {};
    line = line.replace(/-/g, '').trim();
    var lineBlocks = line.split(' ');
    var newLineBlocks = [];
  // Remove extra space
  for (var i = 0; i < lineBlocks.length; i++) {
    if (lineBlocks[i] != "") {
      newLineBlocks.push(lineBlocks[i]);
    }
  }
  line = newLineBlocks.join(' ');
  // "COM - - Box 6: Gross Proceeds"
  if (newLineBlocks[0][newLineBlocks[0].length - 1] == ':') {
    // end work meets
    result.stop = true;
  }
  else if (line.indexOf('Box') >= 0) {
   result.nameAddOn = line.substring(0, line.indexOf('Box')).trim();
 }
 return result;
}

function extractTransaction(line, nameOnly, transactionName) {
  var result = {};
  if(!isValidTransaction(line)) {
    return result;
  }
  // 1: find the first / 
  var firstDashIndex = line.indexOf('/');
  // 2: find the index of last decimal digit of quantity
  var charCount = 0;
  var nameQuantity;
  var transaction;
  for (var i = firstDashIndex - 1; i >= 0; i--) {
    if (line[i] != ' ') {
      charCount += 1;
    }
    if (charCount == 3) {
      nameQuantity = line.substring(0, i+1);
      transaction = line.substring(i+1).replace(/\s+/g, '');
      break;
    }
  }
  if (!nameQuantity || !transaction || !nameQuantity.indexOf('.')) return result;
  // try to extract names
  var nameQuantityBlocks = nameQuantity.split(' ');
  if (nameQuantityBlocks.length == 1) {
    // only quantity exists
  }
  else {
    if (nameQuantityBlocks[0].indexOf(':') == nameQuantityBlocks[0].length - 1) {
      result.stop = true;
    }
    else {
      for (var i = nameQuantityBlocks.length - 1; i >= 0; i--) {
        var dotIndex = nameQuantityBlocks[i].indexOf('.');
        if (dotIndex == 0) {
          result.nameAddOn = nameQuantityBlocks.splice(0, i - 1).join(' ');
          break;
        }
        else if (dotIndex > 0){
          result.nameAddOn = nameQuantityBlocks.splice(0, i).join(' ');
          break;
        }
      }
    }
  }
  if (nameOnly) {
    return result;
  }
  result.name = transactionName;
  // try to extract transaction
  var loss = transaction.match(/\(|\)|\{|\}/g) ? true : false;
  transaction = transaction.replace(/\(|\)|\{|\}|\,/g, '');
  var transactionBlocks = transaction.split('$');
  if (transactionBlocks.length != 7) {
    return result;
  } 
  if (transactionBlocks[0].length == 20) {
    var purchaseDateString = transactionBlocks[0].substring(0,10).replace(/o/g,'0');
    var soldDateString = transactionBlocks[0].substring(10).replace(/o/g,'0');
    if (isNaN(purchaseDateString.substring(purchaseDateString.length - 4))) {
      purchaseDateString = purchaseDateString.substring(0, purchaseDateString.length - 4) + year;
    }
    if (isNaN(soldDateString.substring(soldDateString.length - 4))) {
      soldDateString = soldDateString.substring(0, soldDateString.length - 4) + year;
    }
    if (isValidDateString(purchaseDateString)) {
      result.purchase = purchaseDateString;
    } 
    if(isValidDateString(soldDateString)) {
      result.sold = soldDateString;
    }
  }
  // TODO: ADD information from loss/gain
  if (!isNaN(transactionBlocks[1])) result.proceeds = transactionBlocks[1];
  if (!isNaN(transactionBlocks[2])) result.cost = transactionBlocks[2];
  return result;
}


function isValidTransaction(str) {
  if (str.match(/\$/g) && str.match(/\$/g).length == 6 && str.match(/\//g) && str.match(/\//g).length == 4) {
    return true;
  }
  return false;
}

function isTransactionLine(str) {
  if(str.match(/\$/g) && str.match(/\$/g).length > 2 && str.match(/\//g) && str.match(/\//g).length > 2) {
    return true;
  }
  return false;
}

function getParameterByName(name, url) {
  if (!url) {
    url = window.location.href;
  }
  name = name.replace(/[\[\]]/g, "\\$&");
  var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
  results = regex.exec(url);
  if (!results) return null;
  if (!results[2]) return '';
  return decodeURIComponent(results[2].replace(/\+/g, " "));
}

function isValidDateString(dateString) {
  var d = new Date(dateString);
  if ( Object.prototype.toString.call(d) === "[object Date]" && !isNaN( d.getTime() )) {
    return true;
  }
  return false;
}

function exportToCsv(filename, rows) {
        var processRow = function (row) {
            var finalVal = '';
            for (var j = 0; j < row.length; j++) {
                var innerValue = row[j] === null ? '' : row[j].toString();
                if (row[j] instanceof Date) {
                    innerValue = row[j].toLocaleString();
                };
                var result = innerValue.replace(/"/g, '""');
                if (result.search(/("|,|\n)/g) >= 0)
                    result = '"' + result + '"';
                if (j > 0)
                    finalVal += ',';
                finalVal += result;
            }
            return finalVal + '\n';
        };

        var csvFile = '';
        for (var i = 0; i < rows.length; i++) {
            csvFile += processRow(rows[i]);
        }

        var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
        if (navigator.msSaveBlob) { // IE 10+
            navigator.msSaveBlob(blob, filename);
        } else {
            var link = document.createElement("a");
            if (link.download !== undefined) { // feature detection
                // Browsers that support HTML5 download attribute
                var url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    }

var lastWorker;
var worker = new Worker('worker.js')
function runOCR(image_data, raw_feed){
  document.getElementById("output").className = 'processing'
  worker.onmessage = function(e){
    document.getElementById("output").className = ''

    if('innerText' in document.getElementById("text")){
      document.getElementById("text").innerText = e.data
    }else{
      document.getElementById("text").textContent = e.data  
    }
    document.getElementById('timing').innerHTML = 'recognition took ' + ((Date.now() - start)/1000).toFixed(2) + 's';
  }
  var start = Date.now()
  if(!raw_feed){
    image_data = o.getImageData(0, 0, c.width, c.height); 
  }
  worker.postMessage(image_data)
  lastWorker = worker;
}
});

</script>

</html>
